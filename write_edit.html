<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="write.css" />
    <title>SG BLOG ê²Œì‹œë¬¼ ìˆ˜ì •</title>

    <!-- Google Fonts ì¶”ê°€ -->
    <link
      href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&family=Noto+Serif+KR&family=Gaegu&family=Nanum+Pen+Script&family=Black+And+White+Picture&display=swap"
      rel="stylesheet"
    />
    <script>
      function popup() {
        var url = "./temp_save.html";
        var name = "temp_save";
        var option =
          "width = 480, height = 300, top = 100, left = 200, location = no";
        window.open(url, name, option);
      }
    </script>
  </head>
  <body>
    <!-- ìƒë‹¨ í—¤ë” -->
    <div class="header">
      <div class="logo">SG Blog</div>
      <div class="buttons">
        <button onclick="popup()">ì„ì‹œ ì €ì¥ ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        <button onclick="openEditSavePopup()">ìˆ˜ì • / ë°œí–‰</button>
        <button onclick="deletePost()">ê²Œì‹œë¬¼ ì‚­ì œ</button>
      </div>
    </div>

    <!-- ë„êµ¬ ëª¨ìŒ -->
    <div class="toolbar">
      <button onclick="openImageUploader()">ì‚¬ì§„</button>
      <input
        type="file"
        id="imageInput"
        accept="image/*"
        onchange="insertImage(event)"
      />
    </div>

    <!-- ê¸€ê¼´ ë° í¬ê¸° ì„¤ì • ë°” -->
    <div class="topbar">
      <select id="fontSelect" onchange="changeFontFamily()">
        <option value="'Nanum Gothic', sans-serif">ë‚˜ëˆ”ê³ ë”•</option>
        <option value="'Noto Serif KR', serif">Noto Serif</option>
        <option value="'Gaegu', cursive">Gaegu</option>
        <option value="'Nanum Pen Script', cursive">ë‚˜ëˆ”íœ</option>
        <option value="'Black And White Picture', cursive">
          Black & White
        </option>
      </select>

      <select id="fontSizeSelect" onchange="changeFontSize()">
        <option value="1">11</option>
        <option value="2">13</option>
        <option value="3">15</option>
        <option value="4">16</option>
        <option value="5">19</option>
        <option value="6">24</option>
        <option value="7">28</option>
        <option value="8">30</option>
        <option value="9">34</option>
        <option value="10">38</option>
      </select>

      <img
        class="lineup"
        src="assets/left.png"
        onclick="changeAlignment('left')"
      />
      <img
        class="lineup"
        src="assets/middle.png"
        onclick="changeAlignment('center')"
      />
      <img
        class="lineup"
        src="assets/right.png"
        onclick="changeAlignment('right')"
      />
      <img class="bold" src="assets/bold.png" onclick="toggleBold()" />
    </div>

    <!-- ê¸€ ì‘ì„± ì»¨í…Œì´ë„ˆ -->
    <div class="editor-container">
      <div class="editor">
        <div contenteditable="true" class="title" id="titleField">ì œëª©</div>
        <div contenteditable="true" class="content" id="contentField">
          ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...
        </div>
      </div>
    </div>

    <script>
      function changeAlignment(alignment) {
        document.execCommand("justify" + alignment);
      }

      function toggleBold() {
        document.execCommand("bold");
      }

      document.addEventListener("selectionchange", function () {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          const parentNode = range.commonAncestorContainer.parentNode;

          if (parentNode) {
            const computedStyle = window.getComputedStyle(parentNode);
            document.getElementById("fontSelect").value =
              computedStyle.fontFamily;
            document.getElementById("fontSizeSelect").value =
              computedStyle.fontSize.replace("px", "");
          }
        }
      });

      //ì‚¬ì§„ì„ ë„£ì„ ìˆ˜ ìˆê²Œ í•˜ëŠ” ê¸°ëŠ¥
      function openImageUploader() {
        document.getElementById("imageInput").click();
      }

      document
        .getElementById("titleField")
        .addEventListener("focus", function () {
          if (this.textContent === "ì œëª©") {
            this.textContent = "";
            this.style.color = "black";
          }
        });

      document
        .getElementById("titleField")
        .addEventListener("blur", function () {
          if (this.textContent.trim() === "") {
            this.textContent = "ì œëª©";
            this.style.color = "#aaa";
          }
        });

      document
        .getElementById("contentField")
        .addEventListener("focus", function () {
          if (this.textContent === "ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...") {
            this.textContent = "";
            this.style.color = "black";
          }
        });

      document
        .getElementById("contentField")
        .addEventListener("blur", function () {
          if (this.textContent.trim() === "") {
            this.textContent = "ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...";
            this.style.color = "#aaa";
          }
        });

      function changeFontFamily() {
        let selectedFont = document.getElementById("fontSelect").value;
        document.execCommand("styleWithCSS", false, true); // CSS ì ìš© í™œì„±í™”
        document.execCommand("fontName", false, selectedFont);
      }

      function changeFontSize() {
        let selectedSize = document.getElementById("fontSizeSelect").value;
        document.execCommand("styleWithCSS", false, true);
        document.execCommand("fontSize", false, selectedSize); // ì„ì‹œ í¬ê¸° ì„¤ì •

        // ì„ íƒëœ í…ìŠ¤íŠ¸ì— ì ìš©ëœ font-sizeë¥¼ ë³€ê²½
        let fontElements = document.querySelectorAll("font[size='7']");
        fontElements.forEach((el) => {
          el.removeAttribute("size");
          el.style.fontSize = selectedSize + "px";
        });
      }

      document.addEventListener("selectionchange", function () {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);
          const parentNode = range.commonAncestorContainer.parentNode;

          if (parentNode) {
            const computedStyle = window.getComputedStyle(parentNode);
            document.getElementById("fontSelect").value =
              computedStyle.fontFamily;
            document.getElementById("fontSizeSelect").value =
              computedStyle.fontSize.replace("px", "");
          }
        }
      });

      //------------------------------------------------------------------------
      //ê²Œì‹œê¸€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ì„œ í™”ë©´ì— í¸ì§‘ ê°€ëŠ¥í•œ ìƒíƒœë¡œ ë„ìš°ê¸°

      document.addEventListener("DOMContentLoaded", async function () {
        const postId = new URLSearchParams(window.location.search).get("id");

        if (!postId) {
          alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
          window.location.href = "/myblog.html";
          return;
        }

        try {
          const accessToken = localStorage.getItem("access_token");

          if (!accessToken) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = "/login.html";
            return;
          }

          let apiUrl = `http://127.0.0.1:8000/posts/me/${postId}/`; // âœ… ê¸°ë³¸ê°’: ê²Œì‹œ ì™„ë£Œëœ ê¸€
          let response = await fetch(apiUrl, {
            method: "GET",
            headers: { Authorization: `Bearer ${accessToken}` },
          });

          // âœ… ê²Œì‹œ ì™„ë£Œëœ ê¸€ì´ ì—†ìœ¼ë©´, ìë™ìœ¼ë¡œ ì„ì‹œì €ì¥ API ìš”ì²­
          if (response.status === 404) {
            console.log(
              "ğŸ“Œ ê²Œì‹œ ì™„ë£Œëœ ê¸€ì´ ì—†ìœ¼ë¯€ë¡œ ì„ì‹œì €ì¥ ê¸€ì„ ì¡°íšŒí•©ë‹ˆë‹¤..."
            );
            apiUrl = `http://127.0.0.1:8000/posts/drafts/${postId}/`; // âœ… ì„ì‹œì €ì¥ API
            response = await fetch(apiUrl, {
              method: "GET",
              headers: { Authorization: `Bearer ${accessToken}` },
            });
          }

          if (response.status === 403) {
            alert("ğŸš¨ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ê²Œì‹œë¬¼ì€ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            window.location.href = "/myblog.html";
            return;
          }

          if (response.status === 404) {
            alert("âŒ ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            window.location.href = "/myblog.html";
            return;
          }

          if (response.status === 401) {
            alert("ğŸ”’ ë¡œê·¸ì¸ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”.");
            window.location.href = "/login.html";
            return;
          }

          if (!response.ok) {
            throw new Error("ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }

          // âœ… ê²Œì‹œë¬¼ ë°ì´í„° ì €ì¥
          const postData = await response.json();

          // âœ… ì œëª© ì±„ìš°ê¸°
          document.getElementById("titleField").innerText = postData.title;

          // âœ… ë³¸ë¬¸ ë‚´ ì´ë¯¸ì§€ URLì„ BASE64 ë³€í™˜ í›„ ì ìš©
          const updatedContent = await replaceImageUrlsWithBase64(
            postData.content,
            postData.images
          );
          document.getElementById("contentField").innerHTML = updatedContent;
        } catch (error) {
          console.error("ğŸš¨ ê²Œì‹œë¬¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
        }
      });

      // âœ… ì´ë¯¸ì§€ URLì„ BASE64ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
      async function convertImageUrlToBase64(url) {
        try {
          const response = await fetch(url);
          const blob = await response.blob();
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        } catch (error) {
          console.error("ğŸš¨ ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨:", error);
          return url; // ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì›ë³¸ URL ìœ ì§€
        }
      }

      // âœ… content ë‚´ë¶€ ì´ë¯¸ì§€ URLì„ BASE64ë¡œ ë³€í™˜í•˜ì—¬ ì ìš©
      async function replaceImageUrlsWithBase64(content) {
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = content;
        const images = tempDiv.querySelectorAll("img");

        const imagePromises = Array.from(images).map(async (img) => {
          let imageUrl = img.getAttribute("src");

          // âœ… ì´ë¯¸ì§€ê°€ ì´ë¯¸ BASE64ì¸ ê²½ìš° ë³€í™˜í•˜ì§€ ì•ŠìŒ
          if (imageUrl.startsWith("data:image")) {
            return;
          }

          // âœ… ìƒëŒ€ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€ê²½
          if (imageUrl.startsWith("/media")) {
            imageUrl = `http://127.0.0.1:8000${imageUrl}`;
          }

          const base64Data = await convertImageUrlToBase64(imageUrl);
          img.src = base64Data; // âœ… BASE64 ë³€í™˜ í›„ ì´ë¯¸ì§€ src ë³€ê²½
        });

        await Promise.all(imagePromises); // ëª¨ë“  ì´ë¯¸ì§€ ë³€í™˜ ì™„ë£Œ í›„ ì ìš©
        return tempDiv.innerHTML;
      }

      //==================================================================================

      document.addEventListener("DOMContentLoaded", function () {
        let selectedImage = null; // í˜„ì¬ ì„ íƒëœ ëŒ€í‘œì‚¬ì§„

        function insertImage(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            const figure = document.createElement("figure");
            figure.style.textAlign = "center";
            figure.style.margin = "15px 0";
            figure.style.position = "relative"; // ë²„íŠ¼ì„ ìœ„í•œ position ì„¤ì •

            const img = document.createElement("img");
            img.src = e.target.result;
            img.style.maxWidth = "300px";
            img.style.height = "auto";
            img.style.marginTop = "10px";
            img.style.borderRadius = "5px";
            img.style.cursor = "pointer";
            img.classList.add("editable-image"); // ì´ë¯¸ì§€ì— í´ë˜ìŠ¤ ì¶”ê°€

            const uniqueId = "caption_" + crypto.randomUUID(); // UUID ê¸°ë°˜ ID ìƒì„±
            const caption = document.createElement("figcaption");
            caption.contentEditable = "true";
            caption.classList.add("image-caption");
            caption.style.fontSize = "14px";
            caption.style.marginTop = "5px";
            caption.style.cursor = "text";
            caption.style.color = "gray";
            caption.innerHTML = `<input type="text" id="${uniqueId}" placeholder="ì´ë¯¸ì§€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”...">`;

            caption.style.display = "none";

            const selectButton = document.createElement("button");
            selectButton.contentEditable = "false";
            selectButton.innerText = "ëŒ€í‘œì‚¬ì§„ ì„ íƒ";
            selectButton.style.position = "absolute";
            selectButton.style.bottom = "30px";
            selectButton.style.left = "50%";
            selectButton.style.transform = "translateX(-50%)";
            selectButton.style.padding = "5px 10px";
            selectButton.style.fontSize = "12px";
            selectButton.style.border = "none";
            selectButton.style.borderRadius = "5px";
            selectButton.style.backgroundColor = "rgba(0, 0, 0, 0.7)";
            selectButton.style.color = "white";
            selectButton.style.cursor = "pointer";
            selectButton.style.display = "none"; // ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€
            selectButton.style.userSelect = "none";

            // ì´ë¯¸ì§€ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ë²„íŠ¼ í‘œì‹œ
            figure.addEventListener("mouseenter", function () {
              selectButton.style.display = "block";
              caption.style.display = "block";
            });

            // ì´ë¯¸ì§€ì—ì„œ ë§ˆìš°ìŠ¤ê°€ ë²—ì–´ë‚˜ë©´ ë²„íŠ¼ ìˆ¨ê¹€
            figure.addEventListener("mouseleave", function () {
              selectButton.style.display = "none";
              let cap_input = document.getElementById("caption_input");
              if (cap_input.value == "") {
                caption.style.display = "none";
              } else {
                caption.style.display = "display";
              }
            });

            // ë²„íŠ¼ í´ë¦­ ì‹œ ëŒ€í‘œì‚¬ì§„ìœ¼ë¡œ ì„ íƒ
            selectButton.addEventListener("click", function (event) {
              event.stopPropagation(); // ë¶€ëª¨ figureì˜ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€

              // ê¸°ì¡´ ëŒ€í‘œì‚¬ì§„ ìŠ¤íƒ€ì¼ í•´ì œ
              if (selectedImage) {
                selectedImage.style.outline = "none";
                selectedImage.dataset.isRepresentative = "false"; // ê¸°ì¡´ ëŒ€í‘œì‚¬ì§„ false ì²˜ë¦¬
              }

              // ìƒˆë¡œìš´ ëŒ€í‘œì‚¬ì§„ ì§€ì •
              selectedImage = img;
              img.style.outline = "4px solid #861f1c"; // ëŒ€í‘œì‚¬ì§„ ìœ¤ê³½ì„  í‘œì‹œ
              img.dataset.isRepresentative = "true"; // ë°ì´í„° ì†ì„±ìœ¼ë¡œ ì €ì¥
            });

            const newLine = document.createElement("div");
            newLine.innerHTML = "<br>"; // ìƒˆë¡œìš´ ì¤„ ì¶”ê°€

            figure.appendChild(img);
            figure.appendChild(selectButton);
            figure.appendChild(caption);

            insertAtCursor(figure);
          };
          reader.readAsDataURL(file);
        }

        function insertAtCursor(element) {
          const contentField = document.getElementById("contentField");
          contentField.focus();

          const selection = window.getSelection();
          if (!selection.rangeCount) {
            contentField.appendChild(element);
            return;
          }

          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(element);

          range.setStartAfter(element);
          range.collapse(true);
          selection.removeAllRanges();
          selection.addRange(range);
        }

        document
          .getElementById("imageInput")
          .addEventListener("change", insertImage);
      });

      function openEditSavePopup() {
        const postId = new URLSearchParams(window.location.search).get("id");
        if (!postId) {
          alert("ê²Œì‹œë¬¼ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        window.open(
          `edit_save.html?id=${postId}`,
          "EditSavePopup",
          "width=600,height=700"
        );
      }

      async function deletePost() {
        const postId = new URLSearchParams(window.location.search).get("id"); // URLì—ì„œ id ê°€ì ¸ì˜¤ê¸°
        const accessToken = localStorage.getItem("access_token");

        if (!postId) {
          alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
          return;
        }

        // âœ… ì‚¬ìš©ì í™•ì¸
        if (
          !confirm(
            "ì •ë§ë¡œ ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì„ì‹œ ì €ì¥ ê²Œì‹œë¬¼ë„ ì´ ë²„íŠ¼ì„ í†µí•´ ì‚­ì œë©ë‹ˆë‹¤. ì‚­ì œ í›„ì—ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          )
        ) {
          return;
        }

        try {
          const response = await fetch(
            `http://127.0.0.1:8000/posts/me/${postId}/manage/`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            }
          );

          if (response.ok) {
            alert("âœ… ê²Œì‹œë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            window.location.href = "/myblog.html"; // ì‚­ì œ í›„ ëª©ë¡ í˜ì´ì§€ë¡œ ì´ë™
          } else if (response.status === 403) {
            alert("ğŸš¨ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
          } else if (response.status === 404) {
            alert("âŒ í•´ë‹¹ ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          } else {
            throw new Error("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
          }
        } catch (error) {
          console.error("ğŸš¨ ê²Œì‹œë¬¼ ì‚­ì œ ì‹¤íŒ¨:", error);
          alert("ê²Œì‹œë¬¼ì„ ì‚­ì œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }

      // âœ… ì´ë¯¸ì§€ ì‚½ì… ì‹œ `caption_input`ì˜ ê°’ ì¶”ì¶œ
      function extractCaptions() {
        const captions = [];
        document.querySelectorAll(".image-caption input").forEach((input) => {
          captions.push(input.value.trim() || "");
        });
        return captions;
      }

      // ğŸ”¥ FormDataì— ì¶”ê°€
      // Base64 ë°ì´í„°ë¥¼ File ê°ì²´ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
      function dataURLToFile(dataUrl, filename) {
        const arr = dataUrl.split(",");
        const mime = arr[0].match(/:(.*?);/)[1];
        const bstr = atob(arr[1]);
        let n = bstr.length;
        const u8arr = new Uint8Array(n);

        while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
        }

        return new File([u8arr], filename, { type: mime });
      }

      // âœ… Base64ë¡œ ì €ì¥ëœ ë³¸ë¬¸ ë‚´ ì´ë¯¸ì§€ë“¤ì„ ì°¾ì•„ì„œ File ê°ì²´ë¡œ ë³€í™˜
      // âœ… Base64ë¡œ ì €ì¥ëœ ë³¸ë¬¸ ë‚´ ì´ë¯¸ì§€ë“¤ì„ ì°¾ì•„ì„œ File ê°ì²´ë¡œ ë³€í™˜í•˜ê³ , ëŒ€í‘œì‚¬ì§„ ì—¬ë¶€ê¹Œì§€ ì²˜ë¦¬
      function extractBase64Images() {
        const images = [];
        const isRepresentativeArray = [];

        document.querySelectorAll(".editable-image").forEach((img, index) => {
          if (img.src.startsWith("data:image")) {
            const file = dataURLToFile(img.src, `image_${index}.png`);
            images.push(file);

            // âœ… ëŒ€í‘œì‚¬ì§„ ì—¬ë¶€ ì €ì¥
            isRepresentativeArray.push(img.dataset.isRepresentative === "true");
          }
        });

        // âœ… ëŒ€í‘œì‚¬ì§„ì´ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë¥¼ ëŒ€í‘œì‚¬ì§„ìœ¼ë¡œ ì„¤ì •
        if (!isRepresentativeArray.includes(true) && images.length > 0) {
          isRepresentativeArray[0] = true;
        }

        return { images, isRepresentativeArray };
      }

      // âœ… ë¶€ëª¨ ì°½ì—ì„œ ìì‹ ì°½ ë©”ì‹œì§€ ìˆ˜ì‹ 

      window.addEventListener("message", async function (event) {
        if (event.data.type === "SAVE_DATA") {
          await handlePublish(event.data.payload);
        } else if (event.data.type === "EDIT_SAVE_DATA") {
          await handleEdit(event.data.payload);
        } else if (event.data.type === "TEMP_SAVE_DATA") {
          await handleTempSave(event.data.payload);
        } else {
          console.log("âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
        }
      });

      async function handleEdit(eventData) {
        console.log("ğŸš€ [ë¶€ëª¨ ì°½] ìˆ˜ì •ëœ ë°ì´í„° ìˆ˜ì‹  ì™„ë£Œ:", eventData);

        const title = document.getElementById("titleField").textContent.trim();
        const contentHTML = document.getElementById("contentField").innerHTML;
        const captionsArray = extractCaptions();
        const { images, isRepresentativeArray } = extractBase64Images();

        const formData = new FormData();
        formData.append("title", title);
        formData.append("content", contentHTML);
        formData.append("category_name", eventData.category);
        formData.append("subject", eventData.subject);
        formData.append("visibility", eventData.open);
        formData.append("status", "published");
        formData.append("captions", JSON.stringify(captionsArray));
        formData.append(
          "is_representative",
          JSON.stringify(isRepresentativeArray)
        );

        const accessToken = localStorage.getItem("access_token");
        const postId = new URLSearchParams(window.location.search).get("id");

        if (!postId) {
          console.error("ğŸš¨ postIdê°€ ì—†ìŠµë‹ˆë‹¤!");
          return;
        }

        console.log(`ğŸ“Œ PATCH ìš”ì²­ ì‹¤í–‰: /posts/manage/${postId}/`);
        console.log("â–¶ ì „ì†¡ ë°ì´í„°:", formData);

        try {
          const response = await fetch(
            `http://127.0.0.1:8000/posts/me/${postId}/manage/`,
            {
              method: "PATCH",
              headers: { Authorization: `Bearer ${accessToken}` },
              body: formData,
            }
          );

          if (response.ok) {
            alert("âœ… ê²Œì‹œë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
            window.location.href = "/myblog.html";
          } else {
            console.error("âš ï¸ ê²Œì‹œë¬¼ ìˆ˜ì • ì‹¤íŒ¨:", await response.text());
            alert("âš ï¸ ê²Œì‹œë¬¼ ìˆ˜ì • ì‹¤íŒ¨");
          }
        } catch (error) {
          console.error("âŒ ê²Œì‹œë¬¼ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜:", error);
        }
      }

      /*
      async function handlePublish(eventData) {
        if (event.data.type === "SAVE_DATA") {
          console.log("ğŸš€ [ë¶€ëª¨ ì°½] ìì‹ ì°½ìœ¼ë¡œë¶€í„° ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ!");
          console.log("ğŸ“¦ ì „ë‹¬ëœ ë°ì´í„°:", event.data.payload);

          // 1. ì œëª©ê³¼ ë³¸ë¬¸, ì‚¬ì§„ ìº¡ì…˜, ëŒ€í‘œì‚¬ì§„ ì—¬ë¶€ ì¶”ì¶œ
          const title = document
            .getElementById("titleField")
            .textContent.trim();
          const contentHTML = document.getElementById("contentField").innerHTML;
          const captionsArray = extractCaptions();

          const { images, isRepresentativeArray } = extractBase64Images();

          if (captionsArray.length !== images.length) {
            console.error("ğŸš¨ captions ë°°ì—´ê³¼ images ë°°ì—´ ê°œìˆ˜ê°€ ë‹¤ë¦…ë‹ˆë‹¤!");
            console.log("â–¶ captions:", captionsArray);
            console.log("â–¶ images:", images);
          }

          // 2. FormData ìƒì„±
          const formData = new FormData();
          formData.append("title", title);
          formData.append("content", contentHTML);
          formData.append("category_name", event.data.payload.category);
          formData.append("subject", event.data.payload.subject);
          formData.append("visibility", event.data.payload.open);
          formData.append("status", "published");
          formData.append("captions", JSON.stringify(captionsArray));
          formData.append(
            "is_representative",
            JSON.stringify(isRepresentativeArray)
          );

          // âœ… Base64ë¥¼ ë³€í™˜í•œ ì´ë¯¸ì§€ë“¤ì„ FormDataì— ì¶”ê°€
          images.forEach((image, index) => {
            formData.append(`images`, image);
          });

          const accessToken = localStorage.getItem("access_token");

          // 3. ë°±ì—”ë“œ ì „ì†¡
          console.log("ğŸ“Œ FormData í™•ì¸");
          console.log("â–¶ ì œëª©:", formData.get("title"));
          console.log("â–¶ ë³¸ë¬¸:", formData.get("content"));
          console.log("â–¶ ì¹´í…Œê³ ë¦¬:", formData.get("category_name"));
          console.log("â–¶ ì£¼ì œ:", formData.get("subject"));
          console.log("â–¶ ê³µê°œ ì„¤ì •:", formData.get("visibility"));
          console.log("â–¶ ìƒíƒœ:", formData.get("status"));
          console.log("â–¶ ìº¡ì…˜ ë¦¬ìŠ¤íŠ¸:", formData.get("captions"));
          console.log("â–¶ ëŒ€í‘œì‚¬ì§„ ì—¬ë¶€:", formData.get("is_representative"));

          try {
            const response = await fetch(
              "http://127.0.0.1:8000/posts/me/create/",
              {
                method: "POST",
                headers: { Authorization: `Bearer ${accessToken}` },
                body: formData,
              }
            );

            if (response.ok) {
              alert("âœ… ê²Œì‹œë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
              window.location.href = "/myblog.html";
            } else {
              alert("âš ï¸ ê²Œì‹œë¬¼ ë“±ë¡ ì‹¤íŒ¨");
            }
          } catch (error) {
            console.error("âŒ ê²Œì‹œë¬¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜:", error);
            alert("ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
        } else {
          console.log("âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
        }
      }  
      */

      async function handleTempSave(eventData) {
        if (event.data.type === "TEMP_SAVE_DATA") {
          console.log("ğŸš€ [ë¶€ëª¨ ì°½] ìì‹ ì°½ìœ¼ë¡œë¶€í„° ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ!");
          console.log("ğŸ“¦ ì „ë‹¬ëœ ë°ì´í„°:", event.data.payload);

          // 1. ì œëª©ê³¼ ë³¸ë¬¸, ì‚¬ì§„ ìº¡ì…˜, ëŒ€í‘œì‚¬ì§„ ì—¬ë¶€ ì¶”ì¶œ
          const title = document
            .getElementById("titleField")
            .textContent.trim();
          const contentHTML = document.getElementById("contentField").innerHTML;
          const captionsArray = extractCaptions();

          const { images, isRepresentativeArray } = extractBase64Images();

          if (captionsArray.length !== images.length) {
            console.error("ğŸš¨ captions ë°°ì—´ê³¼ images ë°°ì—´ ê°œìˆ˜ê°€ ë‹¤ë¦…ë‹ˆë‹¤!");
            console.log("â–¶ captions:", captionsArray);
            console.log("â–¶ images:", images);
          }

          // 2. FormData ìƒì„±
          const formData = new FormData();
          formData.append("title", title);
          formData.append("content", contentHTML);
          formData.append("category_name", event.data.payload.category);
          formData.append("subject", event.data.payload.subject);
          formData.append("visibility", event.data.payload.open);
          formData.append("status", "draft");
          formData.append("captions", JSON.stringify(captionsArray));
          formData.append(
            "is_representative",
            JSON.stringify(isRepresentativeArray)
          );

          const accessToken = localStorage.getItem("access_token");

          // 3. ë°±ì—”ë“œ ì „ì†¡
          console.log("ğŸ“Œ FormData í™•ì¸");
          console.log("â–¶ ì œëª©:", formData.get("title"));
          console.log("â–¶ ë³¸ë¬¸:", formData.get("content"));
          console.log("â–¶ ì¹´í…Œê³ ë¦¬:", formData.get("category_name"));
          console.log("â–¶ ì£¼ì œ:", formData.get("subject"));
          console.log("â–¶ ê³µê°œ ì„¤ì •:", formData.get("visibility"));
          console.log("â–¶ ìƒíƒœ:", formData.get("status"));
          console.log("â–¶ ìº¡ì…˜ ë¦¬ìŠ¤íŠ¸:", formData.get("captions"));
          console.log("â–¶ ëŒ€í‘œì‚¬ì§„ ì—¬ë¶€:", formData.get("is_representative"));

          try {
            const response = await fetch(
              "http://127.0.0.1:8000/posts/me/create/",
              {
                method: "POST",
                headers: { Authorization: `Bearer ${accessToken}` },
                body: formData,
              }
            );

            if (response.ok) {
              alert("âœ… ê²Œì‹œë¬¼ì´ ì„±ê³µì ìœ¼ë¡œ ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
              window.location.href = "/myblog.html";
            } else {
              alert("âš ï¸ ê²Œì‹œë¬¼ ì„ì‹œì €ì¥ ì‹¤íŒ¨");
            }
          } catch (error) {
            console.error("âŒ ê²Œì‹œë¬¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜:", error);
            alert("ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
        } else {
          console.log("âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
        }
      }
    </script>
  </body>
</html>
